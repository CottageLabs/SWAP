{% extends "base.html" %}

{% block content %}

<script>
jQuery(document).ready(function() {    

    var types = ['degree_course_name','degree_institution_name','access_course_name','access_course_college'];
    var trigger = '';
    var selects = function(event) {
        trigger = $(this).attr('id');
                
        var degree = $('#degree_course_name').val();
        var institution = $('#degree_institution_name').val();
        var accesscourse = $('#access_course_name').val();
        var college = $('#access_course_college').val();
        
        var url = '/query/progression';

        var qry = {
            'query': {
                'bool': {
                    'must': []
                }
            },
            'size':1000,
            'facets': {
                'degree_course_name': {
                    'terms': {
                        'field': 'degree_course_name.exact' 
                    }
                },
                'degree_institution_name': {
                    'terms': {
                        'field': 'degree_institution_name.exact' 
                    }
                },
                'access_course_name': {
                    'terms': {
                        'field': 'access_course_name.exact' 
                    }
                },
                'access_course_college': {
                    'terms': {
                        'field': 'access_course_college.exact' 
                    }
                }
            }
        }

        degree.length != 0 ? qry.query.bool.must.push({'term':{'degree_course_name.exact':degree}}) : false;
        institution.length != 0 ? qry.query.bool.must.push({'term':{'degree_institution_name.exact':institution}}) : false;
        accesscourse.length != 0 ? qry.query.bool.must.push({'term':{'access_course_name.exact':accesscourse}}) : false;
        college.length != 0 ? qry.query.bool.must.push({'term':{'access_course_college.exact':college}}) : false;

        $.ajax({
            type:'POST',
            datatype:'JSON',
            url:url,
            contentType: 'application/json',
            cache:false,
            async:false,
            data: JSON.stringify(qry),
            success: function(data) {
                var counter = data.hits.total;
                if ( counter == 0 ) {
                    $('#counter').html('<p class="lead">Sorry, no courses are currently available for your selections. Please try changing some options to widen your search.</p>');
                } else {
                    $('#counter').html('<p class="lead">There are ' + counter + ' suitable matches.</p>');
                }
                for ( var k = 0; k < types.length; k++ ) {
                    var t = types[k];
                    var opts = '<option value="">select ...</option>';
                    var ls = data.facets[t].terms;
                    var curr = $('#' + t).val();
                    for ( var m = 0; m < ls.length; m++ ) {
                        var o = ls[m].term
                        opts += '<option';
                        curr == o ? opts += ' selected="selected"' : false;
                        opts += '>' + o + '</option>';
                    }
                    $('#' + t).html(opts);
                }
                var results = '<table class="table table-striped table-bordered" id="progresstable">';
                results += '<thead>';
                results += '<tr><th>Access course</th><th>Enables</th></tr>'
                results += '</thead><tbody>';
                for ( var h = 0; h < data.hits.hits.length; h++ ) {
                    var hit = data.hits.hits[h]._source;
                    results += '<tr><td>' + hit.access_course_name + '<br><br> at ' + hit.access_course_college + '</td><td>';
                    results += '<h2>' + hit.degree_course_name + '</h2>';
                    results += '<h1>' + hit.degree_institution_name + '</h1>';
                    results += '<p>' + hit.degree_profile_grades_required + '</p>';
                    results += '<p>' + hit.degree_special_requirements + '</p>';
                    results += '<p>' + hit.degree_additional_information + '</p>';
                    results += '</td></tr>';
                }
                results += '</tbody></table>';
                $('#progressoptions').html(results);
            }
        });

    }
    
    $('select').bind('change',selects);

});    
</script>



      <div class="row-fluid">
        
        <div class="span6">
            <div class="hero-unit" style="background-color:#66bbff;">
                <h1 style="color:white;">Progression Service</h1>
            </div>
        </div>
        
        <div class="span6">

            <p class="lead">The SWAP progression services provides information about which courses are available to 
            progress to from the various access courses offered across the Scottish college campuses.</p>
            <p class="lead">Use the selectors below to find suitable matches. The available values will change as 
            you make further choices.</p>
            
        </div>
    </div>


      <div class="row-fluid">
        
        <div class="span6">
            <table class="table table-bordered">
                <tr>
                    <td style="background-color:#66bbff;"><p class="lead" style="color:white;"><b>I would like to study this subject at university</b></p></td>
                    <td><select id="degree_course_name">
            		    <option value="">select ...</option>
            		    {% for opt in selections.degrees %}
            		        <option>{{ opt }}</option>
            		    {% endfor %}
            		</select></td>
                </tr>
                <tr>
                    <td><b>At this university</b></td>
                    <td><select id="degree_institution_name">
            		    <option value="">select ...</option>
            		    {% for opt in selections.institutions %}
            		        <option>{{ opt }}</option>
            		    {% endfor %}
            		</select></td>
                </tr>
            </table>
        </div>
        
        <div class="span6">
            <table class="table table-bordered">
                <tr>
                    <td style="background-color:#66bbff;"><p class="lead" style="color:white;"><b>I am doing (or will do) this access course</b></p></td>
                    <td><select id="access_course_name">
            		    <option value="">select ...</option>
            		    {% for opt in selections.accesscourses %}
            		        <option>{{ opt }}</option>
            		    {% endfor %}
            		</select></td>
                </tr>
                <tr>
                    <td><b>And I am at (or will go to) this college</b></td>
                    <td><select id="access_course_college">
            		    <option value="">select ...</option>
            		    {% for opt in selections.colleges %}
            		        <option>{{ opt }}</option>
            		    {% endfor %}
            		</select></td>
                </tr>
            </table>
            
        </div>
    </div>


<div id="counter"></div>
<div style="margin-top:50px;margin-bottom:100px;" id="progressoptions"></div>


{% endblock %}
